<head>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <h1>Spotify Comments</h1>

    <!--  Setup global functions like cookies and sleep  -->
    <script>
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    </script>

    <!--  .  -->
    <script>
        const spotifyAuthCookieName = "SpotifyAuthToken"
        const spotifyAccessCookieName = "SpotifyAccessToken"
        const CLIENT_ID = "5ee3aedb09a3447da667c5e06c276fb8"
        let scopes = 'user-read-private user-read-email'

        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
            );
        }
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        async function authenticate(){
            setCookie(spotifyAccessCookieName, "")
            setCookie(spotifyAuthCookieName, "")

            let state = uuidv4()
            let CALLBACK_URL = window.location.origin + "/callback.html"
            let queryString = "response_type=code&client_id="+CLIENT_ID+"&scope="+scopes+"&redirect_uri="+CALLBACK_URL+"&state="+state
            let authURL = "https://accounts.spotify.com/authorize?"+queryString
            console.log(authURL)
            let authSite = window.open(authURL, "_blank")
            
            // wait for a successful callback
            while(true){
                await sleep(1)

                let constructedURL = authSite.location.origin + authSite.location.pathname
                if(constructedURL != CALLBACK_URL){continue}

                let code = getParameterByName("code", authSite.location.href)
                //authSite.close()
                
                if(code.length <= 0){
                    code = ""
                }
                setCookie(spotifyAccessCookieName, code)
                
                let accessToken = await getAccessToken(state, code)
                if(accessToken.length <= 0){
                    accessToken = ""
                }
                setCookie(spotifyAccessCookieName, accessToken)
                console.log("Access Token Complete!")

                break
            }
        }

        async function getCurrentlyPlaying(){
            let apiUrl = "https://api.spotify.com/v1/me/player/currently-playing"
            let response = await fetch(apiUrl, {
                headers: {
                    "Authorization": getCookie(spotifyAuthCookieName)
                }
            })
            let json = await response.getJson()
            console.log(json)
        }
    </script>
</body>