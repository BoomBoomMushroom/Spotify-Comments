<head>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <h1>Spotify Comments</h1>

    <div id="song">
        <img src="https://dummyimage.com/300x300" id="albumCover">
        <div id="songData">
            <h2 id="songTitle">Example Song</h2>
            <h4 id="songArtist">By Example Artist</h4>
        </div>
    </div>

    <!--  Setup global functions like cookies and sleep  -->
    <script>
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for(let i = 0; i <ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    </script>

    <!--  .  -->
    <script>
        const spotifyAuthCookieName = "SpotifyAuthToken"
        const spotifyAccessCookieName = "SpotifyAccessToken"
        const CLIENT_ID = "5ee3aedb09a3447da667c5e06c276fb8"
        let scopes = 'user-read-private user-read-email user-read-currently-playing'

        function uuidv4() {
            return "10000000-1000-4000-8000-100000000000".replace(/[018]/g, c =>
                (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
            );
        }
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        async function authenticate(){
            setCookie(spotifyAccessCookieName, "")
            setCookie(spotifyAuthCookieName, "")

            let state = uuidv4()
            let CALLBACK_URL = window.location.origin + "/callback.html"
            let queryString = "response_type=code&client_id="+CLIENT_ID+"&scope="+scopes+"&redirect_uri="+CALLBACK_URL+"&state="+state
            let authURL = "https://accounts.spotify.com/authorize?"+queryString
            console.log(authURL)
            let authSite = window.open(authURL, "_blank")
            
            // wait for a successful callback
            while(true){
                await sleep(1)

                let constructedURL = authSite.location.origin + authSite.location.pathname
                if(constructedURL != CALLBACK_URL){continue}

                let code = getParameterByName("code", authSite.location.href)
                authSite.close()
                
                if(code.length <= 0){
                    code = ""
                }
                setCookie(spotifyAccessCookieName, code)
                
                let accessToken = await getAccessToken(state, code)
                if(accessToken.length <= 0){
                    accessToken = ""
                }
                setCookie(spotifyAuthCookieName, accessToken)
                console.log("Access Token Complete!")

                break
            }
        }

        async function getAccessToken(state, code){
            let BACKEND_API_URL = "https://6ad817e4-d3b4-4e56-bdd1-88dc8590dddb-00-2wvpjzyuxvr1k.picard.replit.dev"
            let callback = window.location.origin + "/callback.html"
    
            let apiUrl = BACKEND_API_URL + "/authorization_code" + "?grant_type=authorization_code&code=" + code + "&redirect_uri=" + callback + "&state=" + state
            let response = await fetch(apiUrl)
            let json = await response.json()
            //console.log(json)
            return JSON.stringify(json)
        }

        async function getCurrentlyPlaying(){
            let tokens = JSON.parse(getCookie(spotifyAuthCookieName))

            let apiUrl = "https://api.spotify.com/v1/me/player/currently-playing"
            let response = await fetch(apiUrl, {
                headers: {
                    "Authorization": tokens["token_type"] + " " + tokens["access_token"]
                }
            })
            let json = await response.json()
            //console.log(json)
            return json
        }

        let albumCoverElement = document.getElementById("albumCover")
        albumCoverElement.width = 150;
        let songNameElement = document.getElementById("songTitle")
        let artistElement = document.getElementById("songArtist")

        function resetAlbum(){
            albumCoverElement.src = "https://dummyimage.com/300x300"
            songNameElement.innerText = "Example Song"
            artistElement.innerText = "By Example Artist"
        }

        setInterval(async ()=>{
            let playingData = await getCurrentlyPlaying()
            console.log(playingData)

            let song = playingData["item"]
            if(song == null){
                return
            }

            // display artwork
            let albumImages = song["album"]["images"]
            for(let i=0; i<albumImages.length; i++){
                if(albumImages[i].height != 300){ continue }
                
                albumCoverElement.src = albumImages[i].url
                break
            }

            // display song name
            songNameElement.innerText = song["name"]

            // display artists
            let artists = song["artists"]
            artistElement.innerText = "By "
            for(let i=0; i<artists.length; i++){
                let artist = artists[i]["name"]
                if (i == 0){
                    artist = " " + artist
                }
                else if(i == artists.length - 1){
                    artist = " & " + artist
                }
                else{
                    artist = ", " + artist
                }
                artistElement.innerText += artist
            }
        }, 1000)
    </script>
</body>